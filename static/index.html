<!DOCTYPE html>
<meta charset="utf-8">
<title>Recorder Thing</title>
<style>
#playback {
  padding-top: 10px;
}

#time {
  position: absolute;
  top: 0px;
  right: 0px;
  padding: 10px;
  background: firebrick;
  color: white;
}

#wami {
  margin-left: 100px;
}
</style>
<button id="start">Start Recording</button>
<button id="stop">Stop Recording</button>
<div id="playback"></div>
<div id="time">Not currently recording.</div>
<div id="wami"></div>
<!-- swfobject is a commonly used library to embed Flash content -->
<script src="swfobject.js"></script>
<script src="jquery.min.js"></script>
<!-- Setup the recorder interface -->
<script src="recorder.js"></script>
<script>
var recordState = "loading";
var recordStart = 0;

setInterval(function() {
  var now = Date.now();
  if (recordStart)
    $("#time").text(((now - recordStart) / 1000).toFixed(2));
}, 50);

$("#stop").click(function stopRecording() {
  if (recordState == "recording") {
    console.log("STOP HAZ BEEN CLICK'D");
    Wami.stopRecording();
    recordState = "uploading";
  }
});

$("#start").click(function startRecording() {
  var playback = $("#playback");
  if (recordState != "idle")
    return;
  recordState = "recording";
  playback.empty();
  Wami.startRecording("/audio",
    Wami.nameCallback(function() {
      console.log("START");
      recordStart = Date.now();
    }),
    Wami.nameCallback(function() {
      playback.empty();
      var audio = document.createElement("audio");
      audio.setAttribute("controls", "controls");
      var source = document.createElement("source");
      source.setAttribute("src", "outfile.mp3?bust=" + recordStart);
      source.setAttribute("type", "audio/mp3");
      audio.appendChild(source);
      source = document.createElement("source");
      source.setAttribute("src", "outfile.ogg?bust=" + recordStart);
      source.setAttribute("type", "audio/ogg");
      audio.appendChild(source);
      playback.append(audio);
      recordState = "idle";
      recordStart = 0;
    }),
    Wami.nameCallback(function() {
      console.log("ERROR");
      alert("ERROR");
      recordState = "idle";
      recordStart = 0;
    })
  );
});

$(window).ready(function() {
  Wami.setup({
    id : "wami",
    onReady : function() {
      recordState = "idle";
    }
  });
});
</script>
