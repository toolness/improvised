<!DOCTYPE html>
<meta charset="utf-8">
<title>Recorder Thing</title>
<style>
body {
}

#recorder {
  position: relative;
  background: #f0f0f0;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 12px;
  padding: 20px;
  min-height: 128px;
}

#recorder button {
  font: inherit;
  border: none;
  cursor: pointer;
  background: gray;
  color: white;
  padding: 10px;
  position: relative;
  z-index: 1000;
}

#recorder button:hover {
  background: black;
}

#recorder.loading:before {
  content: 'Please wait, loading...';
  color: gray;
}

#recorder.uploading:before {
  content: 'Please wait, uploading...';
  color: gray;
}

#recorder:not(.recording) .stop {
  display: none;
}

#recorder:not(.recording) time {
  opacity: 0;
}

#recorder:not(.idle) .start {
  display: none;
}

#recorder .playback {
  position: absolute;
  bottom: 0px;
  left: 0px;
  right: 0px;
  width: 100%;
}

#recorder .playback audio {
  width: 100%;
}

#recorder time {
  padding-left: 10px;
  color: firebrick;
}

#recorder time:after {
  content: 's';
}

#recorder .wami {
  min-height: 10px;
  min-width: 10px;
}
</style>
<div id="recorder">
  <button class="start">Start Recording</button>
  <button class="stop">Stop Recording</button>
  <time></time>
  <div class="playback"></div>
  <div class="wami" id="wami"></div>
<div>
<!-- swfobject is a commonly used library to embed Flash content -->
<script src="swfobject.js"></script>
<script src="jquery.min.js"></script>
<!-- Setup the recorder interface -->
<script src="recorder.js"></script>
<script>
function Recorder(options) {
  var recordState,
      recordStart = 0,
      baseURL = options.baseURL || '',
      wami = options.wami || window.Wami,
      el = $(options.element),
      self = {
        el: el,
        on: function(event, handler) {
          el.bind(event, function(event, arg) {
            handler.call(self, event, arg);
          });
          return self;
        }
      };

  function setRecordState(state) {
    var RECORDING_STATES = "loading idle pre-recording recording uploading";

    if (state == "recording") {
      self.startTime = recordStart = Date.now();
    } else if (state == "idle") {
      self.startTime = recordStart = 0;
      self.metadata = {};
    }
    
    recordState = state;
    self.state = state;
    el.removeClass(RECORDING_STATES).addClass(state);
    el.trigger("state-change");
  }

  setRecordState("loading");
  wami.setup({
    id : $(".wami", el).attr("id"),
    onReady : function() {
      setRecordState("idle");
    }
  });

  window.setInterval(function() {
    var now = Date.now();
    if (recordStart)
      $("time", el).text(((now - recordStart) / 1000).toFixed(2));
  }, 50);

  $(".stop", el).click(function stopRecording() {
    if (recordState == "recording") {
      wami.stopRecording();
      setRecordState("uploading");
    }
  });

  $(".start", el).click(function startRecording() {
    var playback = $(".playback", el);
    if (recordState != "idle")
      return;
    setRecordState("pre-recording");
    playback.empty();
    wami.startRecording(baseURL + "/audio",
      wami.nameCallback(function() {
        setRecordState("recording");
      }),
      wami.nameCallback(function() {
        playback.empty();
        var audio = document.createElement("audio");
        audio.setAttribute("controls", "controls");
        var source = document.createElement("source");
        source.setAttribute("src", "recording.mp3?bust=" + recordStart);
        source.setAttribute("type", "audio/mp3");
        audio.appendChild(source);
        source = document.createElement("source");
        source.setAttribute("src", "recording.ogg?bust=" + recordStart);
        source.setAttribute("type", "audio/ogg");
        audio.appendChild(source);
        jQuery.ajax({
          type: 'POST',
          url: baseURL + '/metadata',
          data: JSON.stringify(self.metadata),
          success: function() {
            playback.append(audio);
          },
          error: function() {
            el.trigger("error", "failed to upload metadata");
          },
          complete: function() {
            setRecordState("idle");
          }
        });
      }),
      wami.nameCallback(function(message) {
        el.trigger("error", message);
        setRecordState("idle");
      })
    );
  });
  
  return self;
}

$(window).ready(function() {
  var recorder = window._recorder = Recorder({
    element: $("#recorder")
  }).on("state-change", function(event) {
    console.log("STATE CHANGE", this.state, this.startTime);
    if (this.state == "recording")
      this.metadata = {startTime: Date.now()};
  }).on("error", function(event, message) {
    console.log("ERROR", message);
  });
});
</script>
