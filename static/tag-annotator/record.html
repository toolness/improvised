<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="../css/recorder-widget.css">
<title>Tag Annotator Recorder</title>
<style>
div.tag {
  padding: 8px;
  background: gray;
  cursor: pointer;
}

div.tag:hover {
  background: black;
  color: white;
}

div.tag:active {
  color: yellow;
}

#current-tag {
  min-height: 50px;
  padding: 8px;
  font-size: 20px;
}
</style>
<div class="recorder" id="my-recorder">
  <button class="start">Start Recording</button>
  <button class="stop">Stop Recording</button>
  <time></time>
  <div class="playback"></div>
  <div class="wami" id="wami"></div>
</div>
<div id="current-tag"></div>
<!-- swfobject is a commonly used library to embed Flash content -->
<script src="../js/swfobject.js"></script>
<script src="../js/jquery.min.js"></script>
<!-- Setup the recorder interface -->
<script src="../js/recorder.js"></script>
<script src="../js/recorder-widget.js"></script>
<script src="http://popcornjs.org/code/dist/popcorn.min.js"></script>
<script id="tags" type="text/plain">
beets
mongrel
dodecahedron
saladmancer
</script>
<script>
// This is just like Popcorn's code plugin, but even simpler
// because we don't need an onFrame callback.

Popcorn.plugin("tag", function(options, f) {
  return {
    start: function(event, options) {
      options.el.text(options.tag);
    },
    end: function(event, options) {
      options.el.text('');
    }
  };
});

Popcorn.tag = {
  startRecording: function startRecording(recorder, el) {
    recorder.metadata = {log: []};
    el.empty();
  },
  record: function record(recorder, tag, el) {
    var time = (Date.now() - recorder.startTime) / 1000;
    if (recorder.state == "recording") {
      recorder.metadata.log.push({
        time: time,
        tag: tag
      });
      el.text(tag + " @ " + time.toFixed(2) + "s");
    }
  },
  annotate: function annotate(pop, metadata, el) {
    function completeLastEntry(endTime) {
      var entry = lastEntry;
      if (!entry)
        return;
      pop.tag({
        start: entry.start,
        end: endTime,
        tag: entry.tag,
        el: el
      });
      lastEntry = null;
    }
  
    var lastEntry = {
      start: 0,
      tag: ""
    };
    metadata.log.forEach(function(entry) {
      var SYNC_OFFSET = 0.75;
      completeLastEntry(entry.time - SYNC_OFFSET - 0.01);
      lastEntry = {
        start: entry.time - SYNC_OFFSET,
        tag: entry.tag
      };
    });
    completeLastEntry(999999);
  }
}

$(window).ready(function() {
  var currTag = $("#current-tag");
  $("#tags").text().trim().split('\n').forEach(function(tag) {
    var div = $('<div class="tag"></div>').text(tag).appendTo("body");
  });
  $(window).on("click", ".tag", function() {
    Popcorn.tag.record(recorder, $(this).text(), currTag);
  });
  var recorder = window._recorder = RecorderWidget({
    element: $("#my-recorder"),
    baseURL: ".."
  }).on("state-change", function(event) {
    console.log("STATE CHANGE", this.state, this.startTime);
    if (this.state == "recording") {
      Popcorn.tag.startRecording(this, currTag);
    } else if (this.state == "idle" && this.metadata) {
      var audio = this.el.find("audio")[0];
      if (audio)
        Popcorn.tag.annotate(Popcorn(audio), this.metadata, currTag);
    }
  }).on("error", function(event, message) {
    console.log("ERROR", message);
  });
});
</script>
